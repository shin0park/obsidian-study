### 1. 시스템 상태 살피기 

`top` 명령어를 통해 시스템의 전반적인 상태를 빠르게 파악할 수 있다.

```sh
$ top -b -n 1
top - 14:50:54 up 19 min,  1 user,  load average: 0.05, 0.01, 0.00
Tasks:  98 total,   1 running,  97 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :    458.1 total,    127.4 free,    109.5 used,    221.3 buff/cache
MiB Swap:    458.0 total,    458.0 free,      0.0 used.    336.2 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
      1 root      20   0  106824  17196  10756 S   0.0   3.7   0:00.76 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kthreadd
      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp
      5 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 slub_flushwq
      6 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 netns
      8 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker/0:0H-events_highpri
     10 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 mm_percpu_wq
     11 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tasks_kthread
     12 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tasks_rude_kthread
     13 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tasks_trace_kthread
     14 root      20   0       0      0      0 S   0.0   0.0   0:00.05 ksoftirqd/0
     15 root      20   0       0      0      0 I   0.0   0.0   0:00.04 rcu_preempt
     16 root      rt   0       0      0      0 S   0.0   0.0   0:00.00 migration/0
     17 root      20   0       0      0      0 I   0.0   0.0   0:00.02 kworker/0:1-cgroup_free
     18 root      20   0       0      0      0 S   0.0   0.0   0:00.00 cpuhp/0
     20 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kdevtmpfs
     21 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 inet_frag_wq
     22 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kauditd
     23 root      20   0       0      0      0 S   0.0   0.0   0:00.00 khungtaskd
     24 root      20   0       0      0      0 S   0.0   0.0   0:00.00 oom_reaper
     27 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 writeback
     28 root      20   0       0      0      0 S   0.0   0.0   0:00.03 kcompactd0
     29 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 cryptd
     30 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kintegrityd
     31 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kblockd
     32 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 blkcg_punt_bio
     33 root      20   0       0      0      0 S   0.0   0.0   0:00.00 xen-balloon
     34 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 tpm_dev_wq
     35 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 md
     36 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 edac-poller
     37 root     -51   0       0      0      0 S   0.0   0.0   0:00.00 watchdogd
     38 root       0 -20       0      0      0 I   0.0   0.0   0:00.01 kworker/0:1H-xfs-log/xvda1
     73 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kswapd0
     76 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfsalloc
     77 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs_mru_cache
     80 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kthrotld
     95 root      20   0       0      0      0 S   0.0   0.0   0:00.00 xenbus
     96 root      20   0       0      0      0 S   0.0   0.0   0:00.00 xenwatch
    135 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 nvme-wq
    137 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 nvme-reset-wq
    139 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 nvme-delete-wq
    165 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 mld
    166 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 ipv6_addrconf
    183 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kstrp
    192 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 zswap-shrink
    193 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker/u31:0
   1028 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-buf/xvda1
   1029 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-conv/xvda1
   1030 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-reclaim/xvd
   1031 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-blockgc/xvd
   1032 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-inodegc/xvd
   1033 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-log/xvda1
   1035 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xfs-cil/xvda1
   1037 root      20   0       0      0      0 S   0.0   0.0   0:00.23 xfsaild/xvda1
   1096 root      20   0   43288  15472  14348 S   0.0   3.3   0:00.14 systemd-journal
   1765 root      20   0   32252  11504   8388 S   0.0   2.5   0:00.06 systemd-udevd
   1814 systemd+  20   0   22564  13792  10448 S   0.0   2.9   0:00.05 systemd-resolve
   1834 root      16  -4   21184   2304   1544 S   0.0   0.5   0:00.00 auditd
   1838 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rpciod
   1839 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 xprtiod
   1929 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 ata_sff
   1949 root      20   0       0      0      0 S   0.0   0.0   0:00.00 scsi_eh_0
   1950 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 scsi_tmf_0
   1954 root      20   0       0      0      0 S   0.0   0.0   0:00.00 scsi_eh_1
   1955 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 scsi_tmf_1
   1970 root      20   0   16364   6416   5532 S   0.0   1.4   0:00.00 systemd-inhibit
   1973 libstor+  20   0    2772   1932   1772 S   0.0   0.4   0:00.01 lsmd
   1976 root      20   0   16848   7952   6956 S   0.0   1.7   0:00.01 systemd-homed
   1977 root      20   0   18708  10032   7804 S   0.0   2.1   0:00.03 systemd-logind
   1978 dbus      20   0    8484   4060   3456 S   0.0   0.9   0:00.01 dbus-broker-lau
   1980 systemd+  20   0  236944   9944   8636 S   0.0   2.1   0:00.03 systemd-network
   1986 dbus      20   0    5248   2832   2376 S   0.0   0.6   0:00.01 dbus-broker
   2004 root      20   0    2684   1136   1048 S   0.0   0.2   0:00.00 acpid
   2009 root      20   0  281944   3668   2780 S   0.0   0.8   0:00.01 gssproxy
   2121 root      20   0 1240168  18676  10532 S   0.0   4.0   0:00.09 amazon-ssm-agen
   2125 root      20   0   14388   7836   6716 S   0.0   1.7   0:00.00 sshd
   2132 root      20   0    4776   2576   2388 S   0.0   0.5   0:00.00 atd
   2133 root      20   0  221360   1072    984 S   0.0   0.2   0:00.04 agetty
   2134 root      20   0  221404   1080    984 S   0.0   0.2   0:00.00 agetty
   2154 chrony    20   0   86328   3076   2504 S   0.0   0.7   0:00.03 chronyd
   2320 root      20   0       0      0      0 I   0.0   0.0   0:00.00 kworker/u30:1-events_unbound
   2417 root      20   0       0      0      0 I   0.0   0.0   0:00.00 kworker/0:0-cgroup_release
   2491 root      20   0       0      0      0 I   0.0   0.0   0:00.00 kworker/u30:2-events_unbound
   2586 root      20   0       0      0      0 I   0.0   0.0   0:00.01 kworker/0:2-events
   2660 root      20   0       0      0      0 I   0.0   0.0   0:00.00 kworker/u30:0-events_unbound
   2667 root      20   0       0      0      0 I   0.0   0.0   0:00.00 kworker/0:3-events
   2689 root      20   0   15992  10156   8436 S   0.0   2.2   0:00.02 sshd
   2978 root      20   0   16364   6364   5480 S   0.0   1.4   0:00.02 systemd-userdbd
   2979 root      20   0   16956   7528   6548 S   0.0   1.6   0:00.00 systemd-userwor
   2980 root      20   0   16956   7568   6588 S   0.0   1.6   0:00.00 systemd-userwor
   2981 root      20   0   16956   7528   6548 S   0.0   1.6   0:00.00 systemd-userwor
   2983 ec2-user  20   0   21904  13912  10452 S   0.0   3.0   0:00.05 systemd
   2984 root      20   0       0      0      0 I   0.0   0.0   0:00.00 kworker/u30:3-events_unbound
   2986 ec2-user  20   0  108164   6576      0 S   0.0   1.4   0:00.00 (sd-pam)
   2993 ec2-user  20   0   15992   6068   4348 S   0.0   1.3   0:00.00 sshd
   2994 ec2-user  20   0  224044   4992   3556 S   0.0   1.1   0:00.01 bash
   3020 ec2-user  20   0  223888   3192   2720 R   0.0   0.7   0:00.00 top
```
- `-b`: Batch Mode
	- 기본적으로 `top`은 화면을 계속 새로고침하며 상호작용하는 방식
	- `-b` 옵션을 주면 키보드 입력에 반응하지 않는 '출력 전용' 모드
- `-n`: Number of iterations
	- `top`이 정보를 몇 번 업데이트하고 종료할지를 결정하는 옵션

1. **구동 시간:** 서버의 현재 시간과 부팅 후 경과 시간(Up time)을 나타낸다.
2. **Load Average:** 현재 시스템이 얼마나 많은 일을 하고 있는지를 나타내는 지표
3. **Tasks:** 현재 구동 중인 프로세스의 개수
4. **CPU/Mem/Swap:** 각 리소스의 사용량을 나타내며, 특히 Swap 사용 여부는 시스템 상태 파악에 중요
5. **프로세스 상세 정보:**
    - **PR/NI:** 프로세스의 실행 우선순위를 결정
    - **VIRT, RES, SHR:** 프로세스가 사용하는 메모리 양을 나타내며, 메모리 누수 확인의 핵심 지표
    - **S (Status):** 프로세스의 상태(CPU 사용 중, I/O 대기, 유휴 상태 등)를 나타냄

### 2. VIRT, RES, SHR의 개념

![](images/Pasted%20image%2020260202235744.png)

- **VIRT (Virtual Memory):** 프로세스에 할당된 가상 메모리 전체 크기. 
	- **정의:** `The total amount of virtual memory used by the task. It includes all code, data and shared libraries plus pages that have been swapped out.`
	- 코드, 데이터, 공유 라이브러리 및 Swap된 페이지를 모두 포함한다. 
	- 실제 할당되지 않은 가상의 공간이므로 이 값이 크다고 해서 반드시 문제가 되지는 않는다.
    
- **RES (Resident Size):** 프로세스가 현재 사용 중인 실제 물리 메모리(RAM) 양. 
	- **정의:** `A task's currently used share of available physical memory.`
	- 메모리 점유율이 높은 프로세스를 찾을 때 가장 중요하게 봐야 할 수치이다.
    
- **SHR (Shared Memory):** 다른 프로세스와 공유하고 있는 메모리 양. 
	- **정의:** `The amount of shared memory used by a task. It simply reflects memory that could be potentially shared with other processes.`
	- 대표적으로 `glibc`와 같은 라이브러리를 공유하여 메모리 낭비를 방지함
    
### 3. Memory Commit의 이해

- 프로세스가 메모리를 요청했을 때 커널이 즉시 물리 메모리를 할당하지 않고, 가상의 주소만 전달하는 것을 **Memory Commit**이라고 한다.
	- 언젠가 이만큼의 메모리를 줄게"라고 약속(Commit)
    
- **동작 과정:** `malloc()` 요청 시 가상 메모리(VIRT)만 증가하며, 실제 쓰기 작업 시 `Page fault` 발생 후 물리 메모리(RES)에 바인딩됨.
    
- **Copy-On-Write (COW):** 
	- ![500](images/Pasted%20image%2020260203001524.png)
	- `fork()` 시 자식 프로세스는 부모의 메모리 영역을 그대로 복사한 것처럼 보이지만, 실제 쓰기 작업이 발생하기 전까지는 메모리 할당을 지연시켜 효율성을 높인다.
		- 자식을 fork 하자마자 부모가 메모리 영역을 자식에게 모두 복사해 할당한다면 엄청난 시간과 메모리 낭비가 발생하기 때문
		- 즉, 자식이나 부모 중 어느 한쪽이 해당 영역에 **실제 쓰기(Write) 작업을 할 때야 비로소** 해당 페이지를 복사하여 새로운 물리 메모리를 할당한다.
	- Memory Commit을 통해 가상 메모리(VIRT) 영역을 먼저 확보(약속)해 두어야만, 커널이 안심하고 실제 물리 메모리 할당을 미루는 COW 기술을 사용할 수 있다.
	  
- **Overcommit:** 
	- 프로세스가 메모리를 요청하면 커널은 Memory Commit을 진행하는데 이때 물리 메모리의 한계를 고려하지 않고 계속해서 약속을 수락하면 **Overcommit** 상태가 된다.
	- 즉, 커널은 가용 메모리보다 더 많은 메모리를 프로세스에게 약속할 수 있다. 
	- 이는 효율적이지만 시스템 응답 불가(Hang)를 초래할 수 있다.
    
- **vm.overcommit_memory 파라미터 제어:** 커널이 Memory Commit 요청을 받았을 때 어떤 기준으로 '승인'할지 결정하는 정책 파라미터이다.
    - **0 (기본값):** 커널이 판단하여 가용 공간보다 작을 때만 커밋 허용.
	    - 기본값이며, 어느 정도의 Overcommit은 허용하되 너무 무리한 요청은 거절하는 '합리적 약속' 모드
    - **1:** 요청된 모든 메모리에 대해 무조건 커밋 진행. 
	    - 메모리 누수 시 위험할 수 있음
    - **2:** 물리 메모리 크기와 swap 영역, 그리고 `vm.overcommit_ratio` 설정 비율에 따라 제한적으로 커밋함.
	    - '지킬 수 있는 약속'만 하는 가장 보수적인 모드로, 시스템의 안정성을 최우선으로 할 때 사용
- **sar를 통한 추적**
	- `sar -r` 명령어를 통해 memory commit 상태 확인 가능하다.
	- 장애가 발생했던 시점의 `%commit` 수치를 확인하여 메모리 부족 여부를 사후 분석할 때 매우 유용하다
	- ```sh
	  $ sar -r
Linux 6.1.159-182.297.amzn2023.x86_64 (ip-172-31-4-90.ec2.internal)     02/02/26 _x86_64_ (1 CPU)

14:31:49     LINUX RESTART      (1 CPU)

14:40:35    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
14:50:20       154008    359036     68624     14.63      2172    190604    204028     21.75     70120    157332       548
15:00:20       124048    341476     85100     18.14      2172    202332    234148     24.96     77088    175480       616
Average:       139028    350256     76862     16.38      2172    196468    219088     23.35     73604    166406       582
	  ```
	- **`kbcommit`**: 현재 시스템 내 프로세스들이 요청(Commit)한 가상 메모리의 총량
	- **`%commit`**: 전체 메모리(물리 메모리 + Swap) 대비 `kbcommit`이 차지하는 비율
	    - 이 수치는 실제 물리 메모리 사용량(RES)이 아니라, 커널이 프로세스들에게 약속한 **가상 메모리(VIRT)의 비중**을 나타냄
- **분석**:
    - `%commit` 수치가 100%를 넘는다면, 시스템은 현재 가용 자원보다 더 많은 메모리를 약속한 **Overcommit** 상태임을 의미함
    - 할당만 해두고 실제 사용하지 않는 메모리가 많다면 이 수치가 높아도 당장 문제가 없으나, 프로세스들이 동시에 실제 쓰기 작업을 시작하면 시스템 부하가 급증하거나 응답 불가 현상이 발생할 수 있음
	  
---
`+`
- **OOM Killer (Out Of Memory Killer)**
	- Memory Commit과 Overcommit이 허용된 상태에서 물리 메모리가 한계에 도달하면, 커널은 시스템 보호를 위해 특정 프로세스를 강제로 종료시킨다. 
	- 어떤 프로세스가 먼저 죽을지는 `oom_score`에 의해 결정된다.
- **Page Cache와의 관계**
	- `top`에서 보이는 가용 메모리가 적어 보여도, 많은 부분이 `cached` 영역으로 잡혀있다면 실제로는 여유가 있는 것이다. 
	- 커널은 I/O 성능 향상을 위해 남는 메모리를 페이지 캐시로 활용하며, 프로세스가 메모리를 필요로 하면 즉시 이를 비우고 할당해 준다


### 4. 프로세스의 상태 보기

`top` 출력 항목 중 `S` 열은 프로세스의 현재 상태를 나타내며, `man` 페이지에서는 다섯 가지로 정의한다.
- ![](images/Pasted%20image%2020260203001732.png)

- **D (Uninterruptible sleep):** 
	- 디스크나 네트워크 I/O를 대기하며 대기 큐(Wait Queue)에 머무는 상태. 
	- 프로세스가 응답을 받을 때까지 아무것도 할 수 없으므로 CPU 사용권을 다른 프로세스에 넘김
	- 즉 interrupt 불가하며 부하 계산(Load Average)에 포함됨
    
- **R (Running):** 실제로 CPU 자원을 소모하며 실행 중인 프로세스
    
- **S (Sleeping):** 요청한 리소스를 즉시 사용할 수 있는 interrupt 가능한 대기 상태. 
	- 특정 시그널을 받으면 즉시 처리할 수 있는 상태로 마킹되어 대기함
    
- **T (Traced or Stopped):** `strace` 등으로 시스템 콜을 추적 중이거나 일시 정지된 상태
    
- **Z (Zombie):** 실행이 완료되었으나 부모 프로세스가 종료 상태를 확인하지 않아 프로세스 테이블에 남아 있는 상태.
	- 즉, PID만 점유한 상태

> **핵심 포인트:** 시스템 부하 계산 시 **D 상태** 프로세스가 많으면 특정 요청이 끝나기를 기다리는 프로세스가 많다는 뜻이므로 부하 수치에 포함된다.


### 5. 좀비 프로세스와 PID 고갈

프로세스는 `fork()`로 생성되어 부모-자식 관계를 맺으며, 자식이 종료되면 부모에게 이를 알려 정보를 정리해야 한다.

- **좀비 프로세스의 발생:** 부모 프로세스가 먼저 종료되거나 자식의 종료 신호를 제대로 처리하지 못할 때 발생
    
- **문제점:** 좀비 프로세스는 CPU나 메모리 리소스를 차지하지는 않지만, **PID(Process ID)**를 점유한다.
    
- **PID 고갈:** 리눅스 커널 파라미터 `kernel.pid_max`에 정의된 최대값(예: 65536)까지 좀비 프로세스가 쌓이면 새로운 프로세스에 할당할 PID가 부족해져 더 이상 프로세스를 생성할 수 없게 된다.


### 6. 프로세스의 우선순위: PR과 NI

커널 스케줄러는 **Run Queue**에 연결된 프로세스 중 우선순위가 가장 높은 것을 꺼내 CPU에 할당(Dispatch)한다.

![](images/Pasted%20image%2020260203001929.png)

- **PR (Priority):** 커널이 인식하는 실제 우선순위 값.
    
- **NI (Nice value):** 우선순위를 조절할 때 사용하는 값(-20 ~ 19). 낮을수록 우선순위가 높음.
    
- **상관관계:** 기본 PR(20)에 NI 값을 더해 최종 PR이 결정됨
    
- **스케줄링 특징:** 
	- ![](images/Pasted%20image%2020260203002049.png)
	- CPU 코어 수보다 실행 중인 프로세스 수가 적으면 `nice` 설정 효과가 미비하지만, 코어 수보다 많은 프로세스가 경쟁할 때 비로소 우선순위 설정의 효과가 확실하게 나타남
    
- **RT (RealTime):** 특정 시간 안에 반드시 종료되어야 하는 중요 프로세스(커널 데몬 등)에 적용되며, 일반 사용자 프로세스보다 항상 먼저 실행된다.


###  요약

- **top 활용:** 시스템 전체 리소스(CPU, Mem, Swap)와 개별 프로세스의 점유 상태를 한눈에 확인할 수 있다.
- **메모리 지표:** **VIRT**는 가상 메모리 전체, **RES**는 실제 물리 메모리 사용량, **SHR**은 공유 메모리 양을 의미한다.
- **Memory Commit:** 프로세스가 메모리를 요청할 때 커널이 즉시 물리 메모리를 주지 않고 실제 사용할 때 할당하는 방식
- **커널 파라미터:** `vm.overcommit_memory`를 통해 커널의 메모리 커밋 동작 방식(무조건 허용, 제한적 허용 등)을 제어할 수 있다.