## Chapter 3. 위험 요소 수용하기

신뢰성을 극대화 한다? 무조건 좋은 것이 아니다.
why? 신뢰성 극대화를 위한 비용상승 또는 속도저하 가 있을 수 있기 때문이다.
사용자는 애초에 적절하게 높은 수준의 신뢰성과 극대화된 신뢰성의 차이를 알아차리지도 못한다.

결론: SRE는 업타임을 극대화 + 서버다운의 위험요소 + 빠른 혁신 + 효과적인 운영 사이의 균형을 찾아서 *사용자의 전체적인 만족도* 향상에 집중해야한다.
(업타임이란? 서비스가 동작을 시작한 이후 장애 없이 실행중인 시간)

### 위험 요소 관리하기
시스템 구축하는 비용에서 신뢰성 증가에 비례하여 비용이 증가하지 않는다.
신뢰성을 향상시켰더니 비용은 100배가 증가할 수도 있는 것이다. 
따라서 신뢰성을 위해 노력하지만 필요이상으로 확보하려고 하지는 않는다.
과할 경우 새로운 기능을 추가하거나 기술부채, 운영비용 감소의 기회를 잃어버리게 된다.
-> 따라서 "*가용성 목표*" 의 최소치와 최대치를 모두 고려해서 보다 더 명확하게 위험요소들을 관리할 수 있다.

### 서비스  위험 측정하기
사실 서비스 위험요소는 잠재적인 요인들이 매우 많기 때문에 특정하기도 측정하기도 어렵다.
따라서 -> *"의도하지 않은 다운 타임"* 에 초점을 맞춘다.
그리고 이 의도하지 않는 다운 타임은 -> 서비스이 *가용성* 수준에 의해 결정된다.
가용성 측정시에는 
[시간 기준으로 한 가용성]이 존재하는데,
```
가용성 = 업타임 / (업타임 + 다운타임)
```
구글같은 *전세계에 분산된 서비스를 운영*하는 기업에서는 의미있는 가용성 지표가 아니다.
장애 분리 방식- 특정 서비스의 트래픽 중 일부를 주어진 시간 동안 세계의 어느 한 지역에서 제공하는 셈.
즉, 전체시간 중 일부는 "정상 동작 중인"상태가 된다.

따라서 이 대신에 "*요청 성공률(request success rate)*"에 기초한 가용성을 정의한다.
```
가용성 = 성공한 요청 수/ 전체 요청 수
```

통상적인 애플리케이션에서 모든 요청이 동일하게 취급될 수는 없지만 (가입요청 실패와 백그라운드에서의  메일 읽기 요청실패와 영향이 다른 것처럼),
최종 사용자 관점에서 볼때, *의도되지 않는 다운타임*에 대한 나름대로 적절한 수치라 볼 수 있다.

`+` 유지보수용 내부 시스템이나 웨어하우스처럼 일정한 간격으로 실행되는 시스템에서도 유용한 가용성 지표로 사용될 수 있다.

-> *서비스마다 분기별 가용성 목표를 설정하고 주 단위 혹은 일 단위로 목표치에 대한 성능을 측정하는 방법이 가장 자주 사용된다.*

### 서비스의 위험 수용도
서비스의 위험을 수용한다? 어떻게 정의할 수 있는가?
이를 정의하기 위해서 SRE는 반드시 제품의 소유자와 협의를 통해 기업의 목표를 우리가 처리할 수 있는 명확한 목표로 설정해야한다.

#### 소비자 대상 서비스 - 위험 수용도
고객에게 제공하고 있는 서비스에는 애플리케이션 사업적 소유자 역할을 하는 "제품팀"이 존재한다.
만약 전담 제품팀이 없다면 엔지니어가 알게 모르게 그 역할을 대신하고 있을 것이다.

서비스 위험 수용도를 결정하기 위해 고려해야하는 요소
- 어느 정도 수준의 위험 수용도가 요구되는가?
- 장애의 종류에 따라 서비스에 미치는 영향이 달라지는가?
- 지속적으로 발생하는 위험중에 어느 지점에 서비스 비용을 투입할 것인가?
- 중요하게 고려해야할 다른 서비스 지표로는 어떤 것이 있을까?

1. 목표 가용성 수준
   target level of availability.
   *어느 정도 수준의 위험수용도가 요구되는 가를 구글은 "목표 가용성 수준"을 설정하여 고려하는 것 같다.*
   
   구글은 아래의 사항을 고려하여 목표 가용성 수준을 결정한다.
	   - 사용자는 어느 정도 수준의 서비스를 기대하는가
	   - 이 서비스가 수익과 직접적으로 연관이 있는가
	   - 유료 서비스인가 무료서비스인가
	   - 시장에 경쟁자는 어느 정도 수준의 가용성을 제공하는가
	   - 개인 사용자를 위한 서비스인가 기업사용자를 위한 서비스인가
	     
	예시)
	기업용 구글앱스의 경우 장애가 나면 이 서비스를 이용하는 모든 기업의 장애가 된다.
	따라서 더 높은 수준의 가용성을 설정한다.
	이와 달리 유튜브 같은 개인고객 중심 서비스의 경우 신속한 기능개발이 우선이였기 때문에 비교적 낮은 가용성 목표를 설정했다.
	
2. 장애의 종류
   *어떤 장애냐에 따라 기업에 미치는 영향이 다르기 때문에, 이를 예측하는 것도 중요하다.*
   만약 단순 이미지 렌더링 장애라면 전체시스템을 중단보단 그때마다 대응하는게 나을 것이고,
   개인정보 유출과 관련된 장애인 경우 아예 서비스를 중단시키는 것이 적절한 선택이 될수도 있다.
   특히, 간혹 구글 서비스 구글 애드의 프런트 서비스는 업무시간에만 주로 사용되기 때문에, 정기적으로 예정된 일정에 서비스를 중단하고 유지보수를 한다 -> 이는 *의도된 다운타임*이다. (의도되지 않는 다운타임으로 치지 않는다.)

3. 비용
   적절한 목표 가용성 수준을 결정하기 위해 고려해야할 핵심 요소이다.
   - 서비스를 구축 운영하는데에 있어 상향조성된 목표 가용성 수준이 수익에 어떤 긍정적 영향을 미치는가
   - 발생 가능한 추가 수익이 목표한 가용성 수준에 도달하기 위한 비용을 상쇄할 수 있는가
     
    만약 향상시킨 가용성에 해당하는 수준의 가치 비용이 
    실제 그 가용성을 높이기 위해 드는 비용보다 낮으면
    해당 가용성을 높일 이유가 없게된다.

	ISP 백그라운드 에러율
	서비스에서 발생하는 에러가 만약 ISP 백그라운드 에러율보다 낮게 유지할 수 있다면,
	해당 에러는 사용자의 인터넷 연결 상태에 의해 발생하는 에러에 묻힐 수 있다.
	ISP 평균 에러율 : 0.01% ~ 0.1%

4. 기타 서비스 지표
   응답속도: 구글의 웹검색 출시시, 가장 핵심 요구사항
   반대로
   구글 광고 시스템 애드센스: 비교적 늦은 응답속도를 감수할 수 있는 경우, 비용 절감.

### 에러 예산 활용해보기
개발팀과 SRE 사이의 서로 다른 업무적 특성
개발팀: 신규기능 출시, 빠른 배포 
SRE: 신뢰성 중시, 많은 변경사항 배제

주로 발생하는 의견대립
- 소프트웨어 결험 허용
- 테스트
- 출시 빈도
- 카나리 테스트 빈도와 규모

결국 양쪽 모두 동의할 수 있는 *목표 지표*를 설정하여 협상을 이를 토대로 해야한다. 데이터에 기반한 것일 수록 더 나은 결정이 될 것.
#### 에러 예산 산정
*SLO(Service Level Objectives, 서비스 수준 목표)* 를 산정하여 명확한 목표 지표를 설정할 수 있다.
- 제품 관리자들이 서비스의 분기별 예상 업타임을 의미하는 SLO를 산정한다.
- 실제 업타임은 모니터링 시스템으로 측정한다.
- 실제 업타임과 선정한 SLO의 차이점이 얼마만큼의 "불안정성"을 허용할 것인지 의마하는 "예산"이 된다.
- 업타임이 SLO를 초과한다면 새로운 릴리즈 출시 할 수 있다.

장점
- 개발팀 SRE팀 사이의 균형을 찾는데 필요한 기준치 제공
- 컨트롤 루프 사용 (시스템이 SLO 기준에 부합한다면 새로운 기능을 계속해서 릴리즈하는 것)

-> 에러예산은 신뢰성에 대한 목표치가 필요이상으로 높게 설정된 경우와 이로써 소비되는 비용과 느린 혁신을 드러내는데 일조한다.


## Chapter 4. 서비스 수준 목표

SLI : 서비스 수준 척도 Service Level Indicator
SLO: 서비스 수준 목표 Service Level Objectives
SLA: 서비스 수준 협약 Service Level Agreement

위의 세가지를 통해 주요 지표들의 기본 속성, 적정 갑스 기대했던 수준의 서비스를 제공하지 못했을때의 대처방안 등을 알 수 있다.
SRE는 이 지표를 확인함으로써 "서비스가 문제없이 동작중 이라는 확신을 가질 수 있다."

1. 척도 SLI
   응답속도, 전체 요청 수 대비 에러율, 시스템 처리량 등의 값들의
   평균 or 백분율 계산.
   값을 측정하기 어려운 경우 그에 준하는 대체값으로 사용.
   가장 중요한 SLI : *가용성*

2. 목표 SLO
   SLO: SLI 에 의해 측정된 서비스 수준 목표 값 또는 일정 범위의 값을 의미
	```
	SLI <= 목표치
	최솟값 <= SLI <= 최댓값
	```
	SLO 를 설정하는 것은 생각보다 복잡하다.
	- 필요한 값을 항상 얻어낼 수 없다.(HTTP 요청의 경우, QPS초당쿼리수는 사용자가 얼마나 사용하냐에따라 다르기에 측정하기 어렵다.)
	- 부하가 한계치를 넘어서면 성능이 갑자기 뚝 떨어지는 현상이 있기도해서 지표를 정하는것이 쉽지는 않다.
	그래도 SLO를 설정하고 고객에게 이를 공개하는 것이
	서비스 동작에 대한 예측을 가능하게 되고, 근거 없는 불평을 줄일 수 있다.

3. 협약 SLA
   SLO를 만족하지 못했을 경우의 댓가에 대한 사용자와의 명시적 혹은 암묵적인 계약을 의미
   SRE는 SLA 체결에는 관여하지 않는다.
   -> 사업부 및 제품에 대한 의사결정과 관련, 하지만 SLO 달성을 위해서는 SRE의 도움이 필요, 객관적으로 측정되어야함.
   ex) 구글 검색: 중요한 서비스임에도 SLA가 존재하지 않는 서비스의 좋은예,
   기업용 구글앱스는 명확한 SLA를 체결


### 지표설정
*모니터링 시스템을 통해 추적할 수 있는 모든 지표를 SLI 로 취급할 필요는 없다.*
너무 많은 지표도 적은 지표도 좋지 않다.

- 사용자가 직접 대면하는 시스템: 가용성, 응답시간, 처리량(얼마나 많은 요청을 처리하는가)
- 저장소 시스템: 응답시간, 가용성, 내구성(데이터가 안전하게 저장되는지)
- 데이터 처리 파이프라인 빅데이터 시스템: 처리량, 종단간 응답시간(데이터가 유입된 이후로 완료까지 얼마나걸리는가)
- 모든 시스템은 정확성 중요 - 이는 시스템의 데이터에 대한것이므로 SRE가 관여하지 않는 경우가 대부분

#### 척도 수집
보그몬, 프로메테우스 또는 http 500 로그수집 등의 방법을 통해 서버측에서 수집.
일부는 클라이언트 측에서 필요한 수치 수집

#### 분포 중요
사실 대부분 지표들은 평균보다는 *분포* distribution 가 중요하다. 
일부 요청을 빠르게 처리되었을 수도 있지만 나머지는 더 느리게 될 수 도 있기때문이다.
단순히 평균을 집계하면 전반적인 요청들의 처리속도를 알기 어렵다.

*백분위* 값들을 보통 많이 본다.
99.9번재 백분위 수같으 높은 수들은 최악의 상황을 보여주는 반면
50 백분위(중간값)의 경우 일반적인 상황을 보여준다.

사용자 연구에 의하면
응답시간의 변동이 큰경우보다는 살짝 느리게 동작하는 시스템을 더 선호하므로
-> 99.9 번째 백분위의 값이 양호한 것이 사용자 경험이 더 좋다.

#### 척도의 표준화
SLI 척도를 매번 고민할 필요없도록 표준화 하기를 권장한다.
SLI 템플릿을 설정해두면, 많은 노력을 절감할 수 있다.

### 목표 설정
*목표를 먼저 설정한 후 적절한 척도를 찾는 것이 더 낫다.*
명확성을 극대화 하기 위해 SLO는 측정방식과 유효한 기준이 반드시 명시되어야한다.
에러예산을 산정하고 이를 일 또는 주단위로 추적하는 것이 좋다.
(상위 관리자에게는 월 또는 분기단위로 보고하는 편이 낫다.)

#### 목표치 선택하기
목표치(SLO)선택시 도움되는 권고안
- 현재의 성능을 기준으로 목표치 설정하지 말것.
- 최대한 단순하게 생각할 것
- 자기만족에 얽매이지 말 것
- 가능한 적은 수의 SLO를 설정할 것
- 처음부터 완벽하게 하려고 하지 말 것

#### 측정하기
1. 시스템의 SLI들을 모니터하고 측정하기
2. SLI를 SLO와 비교해서 별도의 대응이 필요한지 판단하기
3. 대응이 필요한 경우 목표치를 달성하기 위해 어떻게 대응할지 파악하기
4. 대응하기

#### SLO는 기대치를 설정하는것.
SLO를 공개한다는 것은??
*시스템의 동작에 대한 기대치를 설정하는 것이다.*

아래 두가지를 고려하라
- 안전제한선을 지킬 것.
  사용자에게 알린 SLO보다 내부적으로 더 보수적으로 설정된 값을 지키면 만성적으로 발생하는 문제들이 외부로 노출되기 전에 대응할 여력을 가질 수 있다.
- 지나친 목표를 설정하지 말 것.


## Chapter 5. 삽질은 이제 그만
### 삽질의 정의
삽질이란 "하고 싶지 않은 일"만을 의미하지 않는다.
프로덕선 서비스를 운영하는 것과 직접적으로 연관 있지만 
- 수작업을 필요로 한다.
  사람이 수작업으로 스크립트를 수행하는 경우들
- 반복적이다.
  한두번이야 삽질이라고 보기 어렵지만 계속 해서 반복되는 작업은 삽질이다.
- 자동화가 가능하다
- 사후대처가 필요하다
  미리 처리할 수 있는 일이 아니라 "사후"에 처리하게 되는 일들.
- 가치가 지속되지 않는다.
  어떤 작업을 했음에도 서비스가 계속 같은 상태로 남아있는 경우
- 서비스 성장에 따라 O(n)으로 증가한다.
  사용자 수에 따라 선형적으로 증가하는 경우
### 삽질이 줄어들면 좋은 이유
SRE 조직은 삽질을 "50%"이내로 유지한다는 목표를 가지고 있다.
나머지 최소 50%는 *엔지니어링 업무*에 할애해야한다.
향후 발생할 삽질을 줄이거나 서비스에 새로운 기능을 추가하는 작업들을 해야한다.
이렇게 서비스를 스케일업 하는 것이 신뢰성 엔지니어링 관점에서 "엔지니어링"이다.

### 엔지니어링에 해당하는 업무는?
새로우면서 본질적으로 사람의 판단을 필요로 하는 업무이다.
서비스의 지속적인 개선을 이뤄내고 창의적이고 혁신적이며, 다지인 주도 접근법으로 해결한다.

SRE 업무 분류

- 소프트웨어 엔지니어링
  코드를 작성 수정, 관련 문서화 작업
- 시스템 엔지니어링
  프로덕션 시스템의 설정 조정
 - 삽질
   서비스 운영과 관련된 반복적으로 발생하는 수작업
- 부하
  서비스 운영과 직접 관련되지 않는 관리 업무. 회의 서류작업 등

### 삽질은 나쁜 것?
삽질이 항상 나쁜것은 아니다.
어느정도 삽질은 피할 수 없다는 것을 분명하게 인식해야한다.
하지만 그양이 엄청나다면 삽질은 독이된다.

이유
- 경력 개발이 침체된다.
- 의욕이 저하된다.
- 혼란이 가중된다.
- 성장이 저하된다.
- 좋지 않은 선례를 남기게 된다.
- 인력 유출이 발생
- 신뢰에 문제가 생긴다.

*삽질은 줄이고 창의적인 일에 더 집중하자!!!*



중요내용 요약

1. 서비스에 적절한 신뢰도를 설정하기 위해서는 서비스 위험 수용도를 측정해야하고,
   요청 성공률 기반의 가용성을 정의해야한다. 의도되지않는 다운타임기반
```
가용성 = 성공한 요청 수/ 전체 요청 수
```
 에러예산 - SLO 산정해서 서비스를 새로 릴리즈 할 것인가, 서비스의 신뢰성을 더 늘리는데 집중할 것인가를 정하는 객관적인 지표로 사용한다는 점. 그리고 개발팀과 SRE간의 업무간의 대립을 줄일 수 있는 요소임을 인지.
 
2. SLI, SLO, SLA의 의미와 SLO 측정시 고려사항
   -> 평균값이 아닌 "분포"를 고려해야한다. 백분위 지표의 이해 

3. 삽질과 엔지니어링 업무의 정의와 SRE 업무는 50% 삽질 50% 엔지니어링 업무여야 발전적이다는 것을 명심하기