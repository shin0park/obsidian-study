### 모니터링과 관련된 용어 정의
- 모니터링
  쿼리의 수와 종류, 에러의 수와 종류, 처리시간 및 서버의 활동시간 등 시스템에 대한 정량적 실시간 데이터 모으고 집계해서 보여주는것
- 화이트박스 모니터링
  시스템의 내부 지표들(로그, http 핸들러)을 토대로 하는 모니터링
- 블랙박스 모니터링
  사용자가 보게 되는 확인 가능한 동작들을 외부에서 테스트하는 과정
- 대시보드
  요약된 뷰를 보여주는 애플리케이션
- 알림
  티켓 메일 알림 및 호출
- 근본 원인
  소프트웨어 결함이나 사람이 실수는 고쳐지면 다시는 그일이 발생하지 않도록 해야한다. 이런 사고가 발생하는 여러 원인들을 의미. 근본적인 원인
- 노드와 머신
  물리적인 서버, 가상머신, 컨테이너
- 푸시
	서비스가 실행하는 소프트웨어나 관련된 설정에 대한 모든 변경사항을 의미

### 모니터링 해야하는 이유
- 장기적인 트렌드 분석
- 시간순 혹은 실험 그룹에 대한 비교
  ex) 지난주 대비 사이트가 늘어났는지, 두가지중 어느것이 쿼리를 더 빨리 실행했는지
- 알림
  당장 수정해야하거나 곧 문제가 생길 가능성이 있어 누군가 봐야할때 통지를 보내야한다.
- 대시보드
  서비스에 대한 기본적인 궁금증 해소
- 임시적인 회고 분석의 수행(디버깅)
  갑자기 지연응답이 발생했을때 그시간에 다른 어떤 일들이 발생했었는가

-> 모니터링과 알림을 이용하면 시스템에 언제 문제가 발생했는지 하려하는지 알 수 있다.
하지만 사람을 호출하는 것은 매우 비용이 많이드는 일이다.
호출이 너무 빈번하면 직원들은 그냥 추축으로 넘어가거나 호출을 무시하게 되고 자칫 진짜 호출마저 무시하게된다.
-> 효과적인 알림시스템은 정확한 신호와 낮은 오보 비율을 갖춰야한다.

### 모니터링에 대한 적절한 기대치 설정
- SRE팀(10-12명) 한명 혹은 두명은 모니터링 시스템을 구축 관리하는 업무를 전담
- 구글은 사후 분석을 통해 간소하고 신속한 모니터링 시스템으로 전환 진행
- 구글은 모니터링 알림 규칙을 지속적으로 리팩토링 하여 최대한 간결하면서도 팀 모두가 이해할 수 있도록 유지하도록 한다.
- 즉, 잘못된 알람비율은 낮게 올바른 알림비율은 높게 유지하기 위해-> 모니터링 시스템은 간결하면서 안정적이어야하며, 알림 발송의 규칙들은 이해하기 쉽고 명확해야한다.

#### 증상과 원인
어떤 장애가 발생했는가: 증상
왜 장애가 발생했는가: 원인
-> 모니터링 시스템을 작성할때 고려해야할 가장 중요한 간극 중 하나.

#### 블랙박스와 화이트박스
중요도 낮은 서비스: 화이트박스 모니터링
중요한 서비스: 블랙박스 모니터링

블랙박스 모니터링: 서버상에 나타나는 증상을 기본으로 하며, 현재 문제가 발생하는 상황을 모니터링
화이트 박스 모니터링: 로그나 HTTP 종단점 같은 시스템 내부 동작들을 규범에 따라 살펴보는 기법

* 블랙박스 모니터링- 이미 문제가 발생한 경우만 사람을 호출하는 원칙을 강제할 수 있다는 장점 존재. 아직 발생하기 않았지만 발생할 문제에 대해서는 도움이 되지 못한다.

### 모니터링의 네 가지 결정적 지표
1. 지연응답
   요청이 서비스에 의해 처리되기까지의 시간
   에러에 대한 응답코드만 보기보다 에러의 지연응답을 추적하는 것이 중요하다.
   (데이터베이스 연결실패로 인해 http 500 발생은 응답이 매우 빠르게 이뤄질수도 있다.)
   
2. 트래픽
   시스템에 얼마나 많은 요청이 들어오는지 측정
   높은 수준의 시스템 관련 지표를 통해 측정 가능.
   
   웹서비스의 경우, 초당 HTTP 요청의 개수
   오디오 스트리밍의 경우, 네트워크 입출력이나 동시 접속 세션수 측정
   키-밸류 저장소의 경우, 트랜잭션의 개수, 초당 조회수 
   
3. 에러
   실패한 요청의 비율
   명시적인 실패(http 500), 묵시적인 실패(http200이지만 잘못된처리)
   프로토콜의 응답코드는 모든 종류의 실패를 표현하기에는 충분하지 않으므로, 내부적인 프로토콜 사용도 고려해야한다.
   
4. 서비스 포화상태
   서비스가 얼마나 "포화" 상태로 동작하는지
   시스템의 일부를 측정하며 가장 병목이 발생하는 리소스를 집중해서 측정
   많은 시스템들이 100퍼 사용량에 도달하기 전에 성능의 하락이 발생하므로 기본적으로 목표 사용량을 설정해야한다.

### 적당한 측정 방법 선택하기
- CPU와 데이터 베이스는 균형있게 사용되지 못하는 경우가 많다. 따라서 모니터링 시스템 구축시, 적당한 수준의 사용량으로 기준으로 삼아야한다.
- 지연응답: 전체요청에 대한 평균 응답시간이 느려지는 것과 마지막 요청이 아주 느려지는 것을 구분하기 위해, 요청 시간에 따른 분포도를 산정해서 시각적으로 확인 할 수 있다. (0밀리초부터 10밀리초이내 요청수, 10밀리초부터 30밀리초내의 요청수 등..)
- 1년에 몇번이하의 다운타임이 발생하는 서비스에 응답여부를 1분에 한두번 확인하는 것 -> 너무 빈번하게 확인하는 것.
-> 시스템을 측정할 때, 어느정도 *세분화*할 것인가에 주의를 기울어야한다.
적당하게

### 더욱 단순하게가 아니라 최대한 단순하게 
모든 요구사항들을 고려하면 모니터링 시스템은 매우 복잡해질 것이다.
따라서 모니터링 시스템 디자인할때는 *최대한 간결함*을 추가해야한다.
- 가장 빈번하게 발생하는 사건을 탐지하기 위한 규칙은 최대한 간결하고 예측가능하며 확실해야한다.
- 수정 빈도가 낮은 데이터의 수집, 알림에 관련된 설정은 제거하는 것이 좋다.
- 수집은 되지만 대시보드에 노출되지도 않고 알림에 사용되지도 않는 데이터 역시 제거하는 것이 좋다.


### 호출에 대한 철학 
- 매번 호출이 울릴때마다 긴급한 상황임을 인지하고 그에 대응해야한다.
- 이러한 긴급호출은 빈번한 호출로 피로를 느끼지 않도록 하루에 단 몇번정도만 발생해야한다.
- 모든 호출은 대응이 가능해야한다.
- 호출에 대한 모든 대응은 이상적이어야한다. 
- 호출은 새로운 문제나 지금까지 보지 못한 사건에 대한것이어야 한다.

### 장기적 모니터링
단기 가용성 목표를 달성할 것인가 vs 장기적인 관점에서 시스템의 성능을 향샹시킬 것인가

사례
- 빅테이블 SRE: 과도한 알림
  알림이 너무 빈번하게 발생하여 엔지니어링 시간을 너무 많이 소모
  필요한 알림을 선별하는데 너무 많은 시간 할애
  
  해결방안-> SLO 목표치 하향조정, 이메일 알림 중단
  이로써 장기적인 문제들을 실질적으로 수정해나갈 여유를 갖게됨
  
- 지메일: 사람이 예측 및 스크립팅 할 수 있는 응답
  스케줄러의 기반 코드에서 수정하기 어려운 불명확한 버그 발견
  해결방안-> 사용자에 대한 영향력 최소화하면서 스케줄러의 동작을 확인하는 도구를 개발

-> 일단 그상황을 해결하기 위해 우회하는 것보다 장기적 해결책을 지원하고 올바른 우선순위를 책정하는 것이 필요하다
쉬쉬하지말고 반드시 바깥으로 끄집어내어 논의해야한다.


#### 핵심내용
- 모니터링의 네가지 결정적인 지표.
  지연응답, 트래픽, 에러, 서비스 포화상태
- 모니터링 시스템 측정 주의사항 
  측정 및 확인 빈도를 어느정도로 세분화 할것인지가 중요하다(1년에 몇번이하의 다운타임이 발생하는 서비스에 응답여부를 1분에 한두번 확인하는 것)
  최대한 간결함을 유지해야한다. (수정 빈도가 낮은 데이터의 수집, 알림에 관련된 설정은 제거하는 것이 좋음. 수집은 되지만 대시보드에 노출되지도 않고 알림에 사용되지도 않는 데이터 역시 제거하는 것이 좋다.)
- 단기적으로 우회하려고 하지말고 장기적인 시스템 성능향상에 노력을 가할 것

#### 새로 알게된 내용
- 블랙박스 모니터링: 서버상에 나타나는 증상을 기본으로 하며, 현재 문제가 발생하는 상황을 모니터링 / 화이트 박스 모니터링: 로그나 HTTP 종단점 같은 시스템 내부 동작들을 규범에 따라 살펴보는 기법
- SRE팀(10-12명) 한명 혹은 두명은 모니터링 시스템을 구축 관리하는 업무를 전담
- 모니터링 시스템은 최대한 간결해야한다는 것. 많은 것을 보고 측정할 수 있다고 좋은 것만은 아니였다는 것. 모든 팀원이 이해할 수 있는 알림규칙이 필요.