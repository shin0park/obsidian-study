# Managing Critical State: Distributed Consensus for Reliability

- 프로세스는 충돌이나 재시작이 필요한 경우가 필연적으로 발생한다. SRE는 장애를 예측하고 분산시스템의 상태에 대해 일관되게 살펴볼 수 있는 방법을 유지해야한다.- 일관된 뷰
- 분산 합의는 일부 시스템 상태에 대한 일관된 뷰가 필요한 안정적이고 가용성이 뛰어난 시스템을 구축하는 데 효과적이다.
- ex. 분산 시스템의 여러 프로세스는 분산 lock 발생 여부 또는 큐의 메시지가 처리 여부에 관계없이 중요한 구성 요소에 대한 일관된 뷰를 형성할 수 있어야 한다.
- 이는 분산 컴퓨팅에서 가장 기본적인 개념 중 하나이다.

#### CAP 이론(CAP Theorem)
CAP 이론(Consistency, Availability, Partition Tolerance)은 분산 시스템이 다음 세 가지를 동시에 만족할 수 없음을 증명하는 이론이다.
- 각 노드에서 데이터에 대한 일관된 뷰
	- 모든 노드가 동일한 데이터를 동일한 시간에 보여줄 것을 보장. 즉, 시스템의 모든 읽기 작업은 가장 최근에 쓰여진 데이터를 반환해야 한다.
- 각 노드에서 데이터의 가용성
	- 모든 요청이 성공적으로 응답을 받아야 한다. 시스템은 일부 노드가 장애가 발생하더라도 서비스를 계속 제공할 수 있어야 함.
- 네트워크 파티션에 대한 장애 허용
	- 네트워크 파티션(노드 간 통신이 단절되는 현상)이 발생하더라도 시스템이 정상적으로 동작해야 한다. 분산 시스템은 네트워크 문제에 견고해야 한다.
-> 만일 두 노드가 분할된 네트워크로 인해 서로 통신할 수 없다면, 모든 요청에 응답할 수 없게 되거나 (가용성 감소), 아니면 요청을 처리하게 됨으로써 각 노드에서 데이터의 불일치가 발생할 수 있다. -> 일관성 없는 뷰를 초래한다.

#### BASE (Basically Available, Soft state, Eventually consistent)
- 많은 분산 데이터 저장소 기법들은 BASE 이론을 제공한다.
- 특정 종류의 데이터를 다루는 애플리케이션에 적합하며, 더 많은 비용이 필요한 대용량 데이터와 트랜잭션을 처리할 수 있다.
	- Basically Available
		- 시스템은 기본적으로 가용성을 보장해야한다. 일부 노드에 장애가 발생해도 시스템은 서비스를 제공해야한다.
	- Soft state
		- 시스템의 상태는 시간이 지남에 따라 변경될 수 있다. (외부 입력없이도 시스템 상태가 변할 수 있다)
	- Eventually Consistent
		- 시스템은 일시적으로 일관성이 깨질 수 있지만, 시간이 지나면 모든 노드가 동일한 상태에 수렴한다.
		- 시스템은 최종적으로 일관성을 유지한다.
- CAP vs BASE
	- CAP 이론은 분산 시스템의 이론적 한계를 설명하는 반면, BASE 이론은 실제 시스템이 어떻게 동작하는지를 설명한다.
- BASE 이론을 지원하는 거의 모든 시스템들은 **멀티마스터 복제(multimaster replication)을 지원한다.
	- 쓰기 작업을 여러 프로세스에서 동시에 수행할 수 있다.
	- 충돌을 해결하는 매커니즘 제공한다.
	- 이 접근 방식은 일반적으로 Eventually Consistent 으로 알려져 있다.
- 하지만 개발자 입장에서 BASE 이론만 지원하는 데이터 저장소를 이용한 시스템을 설계하는 것은 어렵다.
- 따라서 제프 슈테는 "개발자가 최종 일관성에 대처하기 위한 메커니즘을 구현하기 위해서는 상당한 시간을 소비하게 된다는 것을 알았고, 이는 개발자에게 큰 부담이며 일관성 문제는 데이터 베이스 수준에서 해결해야 된다"고 말함.

---

### 합의는 왜 필요할까: 분산 시스템 간의 협업의 실패
Motivating the Use of Consensus: Distributed Systems Coordination Failure

- 분산시스템은 복잡하고 문제를 해결하기 난해하다.
- 특히, 네트워크 파티션은 해결하기가 더욱 어렵고 파티션의 포화로 인한 문제는 아래의 결과로 나타난다.
	- 네트워크가 현저히 느려짐
	- 전부가 아닌 일부 메시지 유실
	- 한 방향으로만 발생하는 트래픽 제한(Throttle)
		- Throttle:시스템(예: API)에 과부하나 과도한 요청을 처리하지 못하도록 **성능이나 요청 수를 제한하는** 기술
- **분산 합의 알고리즘(Distributed Consensus Algorithm) 이란?**
	- 분산 시스템에서 여러 노드가 동일한 상태에 도달하도록 하는 알고리즘
	- 분산시스템에서는 네트워크 지연, 노드 장애,  네트워크 파티션(분할)로 인한 문제들로 인해 노드간 일관성을 유지하기 어렵기 때문
	- 분산 합의 알고리즘은 이러한 문제를 해결하고 일관성과 가용성을 보장하기 위해 설계됨
- 분산 합의 알고리즘의 주요 개념
- 리더 선출 (leader election)
	- 분산 시스템에서 하나의 노드를 리더로 선출하여, 리더가 시스템의 상태를 관리하고 결정을 내리도록 한다. 리더는 다른 노드들과 통신하여 상태를 동기화한다.
	- 리더 선출과 분산 합의 알고리즘(leader election and distributed consensus algorithms)을 활용한 세가지 사례 존재
		- **사례 연구 1: split brain 문제:** 파일 서버 쌍이 동시에 데이터를 쓰려고 하여 데이터 손상이 발생했습니다. 간단한 제한 시간을 사용하여 리더 선출 문제를 해결하려 했기 때문에 발생
		- **사례 연구 2: 사람이 개입해야하는 장애 조치:** 기본 데이터베이스의 상태를 확인할 수 없는 경우 사람에게 에스컬레이션해야 했다. 데이터 가용성에 부정적인 영향을 미치고 운영 로드를 증가시킨다.
		- **사례 연구 3: 그룹-멤버십 알고리즘의 오류:** 네트워크 파티션으로 인해 분리된 각 클러스터들이 다시 마스터를 선출하고 쓰기 삭제 작업을 시작하면서 분리된 뇌 시나리오와 데이터 손실 문제가 발생 

#### 분산에 대한 합의가 동작하는 방식

- 분산 시스템에는 다양한 종류의 장애가 발생할 수 있다.
	- 충돌실패(crash fail) or 충돌 복구(crash recover) 
		- 대부분 실제 시스템에서 발생하는 문제들은 본질적으로 느린 네트워크, 시스템 재시작으로 일시적인 현상이므로 충돌 복구 방식이 더 유용하다.
	- 비잔틴 실패(Byzantine failure), 논비잔틴 실패(non Byzantine failure)
		- 비잔틴 실패는 프로세스가 버그나 악의적인 동작으로 인해 올바르지 않는 메시지를 전달할 때 발생하며, 상대적으로 처리 비용이 높고 발생빈도는 낮다.
- 시스템이 대부분의 시간 동안 안정적으로 진행할 수 있도록 충분한 정상 복제본과 네트워크 연결을 갖도록 보장하여 제한된 시간에 분산 합의 문제를 해결하고 있다

#### **Paxos 살펴보기: 예시 프로토콜**

- 분산합의 알고리즘 주요 개념
- 로그 복제(Log Replication)
	- 리더가 결정한 상태 변경 사항을 다른 노드들에게 복제하여, 모든 노드가 동일한 상태를 유지하도록 한다.
	- ex. Raft 알고리즘에서는 리더가 클라이언트의 요청을 로그에 기록하고, 다른 노드들에게 로그를 복제 함.
- **과반수 합의(Quorum)** 존재
	- 시스템의 결정은 과반수 이상의 노드가 동의해야 유효하다. 이를 통해 일부 노드의 장애에도 시스템이 정상적으로 동작할 수 있다.
- **Paxos**
	- Paxos는 분산 시스템에서 합의를 달성하기 위한 가장 기본적인 알고리즘 중 하나이다. 
	- Paxos는 리더 선출, 로그 복제, 과반수 합의 등의 개념을 사용하여 시스템의 일관성을 유지한다.
	- Paxos는 일련의 제안(Proposal)으로 동작하며, 이 제안은 시스템의 과반수 프로세스에 의해 수락될 수도 있고 그렇지 않을 수도 있다.
	- 제안이 수락되지 않으면 실패하며, 각 제안에는 시퀀스 번호가 있어 시스템의 모든 작업에 엄격한 순서를 부여한다.
		- 프로토콜의 첫 번째 단계에서 제안자(Proposer)는 시퀀스 번호를 수락자(Acceptor)에게 보낸다.
		- 각 수락자는 더 높은 시퀀스 번호의 제안을 아직 보지 못한 경우에만 제안을 수락한다. 
		- 제안자는 필요한 경우 더 높은 시퀀스 번호로 다시 시도할 수 있고, 제안자는 고유한 시퀀스 번호를 사용해야 한다. (예: 호스트 이름을 시퀀스 번호에 포함).
		- 제안자가 과반수 수락자로부터 동의를 받으면, 값을 포함한 커밋 메시지를 보내 제안을 커밋할 수 있다.
		- 과반수 커밋 요구사항은 같은 제안이 다른 값으로 커밋되는 것을 방지한다. 두 과반수는 최소한 하나의 노드에서 겹치기 때문
	- Paxos 그 자체 프로토콜로는 그다지 유용하지 않다.
		- 제안의 일련 번호와 그 값의 처리에 동의하는 것뿐이고, 정해진 수의 노드만 값에 동의하기만 하면 되므로 어떤 노드든 전체 집합을 완전히 볼 수 없기 때문이다.
    - 이론적으로 매우 강력하지만, 구현이 복잡하고 이해하기 어렵다.
    - 실제 시스템에서는 변형된 버전(예: Multi-Paxos)이 사용

#### 분산 합의를 위한 시스템 아키텍처 패턴
- 분산 합의 알고리즘은 저수준 이며 원시적이다.
- 단순히 노드 집합이 한번에 하나의 값에 동의할 수 있게 해줄 뿐이다.
- 분산 합의가 유용해지려면 데이터 저장소, 설정 저장소, 큐, lock, 리더 선출 서비스를 좀 더 높은 수준의 시스템 컴포턴트들이 제공해야한다.
- 합의 알고리즘을 성공적으로 사용하고 있는 시스템
	- Zookeeper, Consul, etcd
	- Zookeeper는 분산 합의를 사용하도록 설계되지 않은 애플리케이션에서도 쉽게 사용할 수 있어 산업계에서 처음으로 널리 사용된 오픈 소스 합의 시스템이다.

#### 신뢰할 수 있는 복제된 상태 머신
Replicated State Machine, RSM

- 복제 상태 머신(RSM)은 여러 프로세스에서 동일한 작업 집합을 동일한 순서로 실행하는 시스템
- RSM은 데이터 또는 설정 저장소, lock, 리더 선출과 같은 유용한 분산 시스템 컴포넌트와 서비스를 구축하기 위한 기본적인 단위이다.
- RSM의 작업은 분산합의 알고리즘을 통해 전역적으로 순서가 지정된다.
- 많은 논문에서는 결정론적 프로그램을 RSM으로 구현함으로써 고가용성을 확보한 복제 서비스로 구현할 수 있음을 보여줬다.
- ![](images/Pasted%20image%2020250223204625.png)
- RSM은 분산합의 알고리즘 위의 논리적 계층에서 구현된 시스템이다.
- 합의 알고리즘은 작업 순서에 대한 합의를 다루고, RSM은 그 순서대로 작업을 실행한다.

#### 분산 조정(Coordination)과 잠금 서비스

- Barrier
	- 분산 연산에서 장벽(barrier)은 특정 조건을 만족할 때까지 프로세스의 그룹이 작업을 수행하지 못하도록 하는 기본적인 기능이다.
	- 배리어를 사용하면 분산 계산을 논리적 단계로 나눌 수 있다.
		- ex. MapReduce 모델에서 전체 Map 단계가 완료된 후 Reduce 단계가 진행되도록 보장하는 데 사용가능
	- 배리어는 RSM으로 구현될 수도 있으머. Zookeeper 합의 서비스가 이 방법으로 구현된 것이다.
- 잠금(Lock)
	- 또 다른 유용한 기본적인 기능으로 RSM으로 구현될 수 있다.
	- 분산 시스템에서 작업자 프로세스가 일부 입력 파일을 원시적으로 처리하는 경우, 분산 잠금을 사용하여 여러 작업자가 동일한 입력 파일을 처리하지 못하도록 할 수 있다. 
	- 실제로는 무기한 잠금 대신 시간 초과가 있는 갱신 가능한 임대를 사용하는 것이 필수적이다. 
	- 이는 충돌한 프로세스가 잠금을 무기한 보유하는 것을 방지한다.

#### 신뢰할 수 있는 분산 큐와 메시징

- 큐는 일반적인 데이터 구조로, 종종 여러 작업자 프로세스 간 작업을 분배하는 방법으로 사용된다.
- 큐 기반 시스템은 장애 및 작업자 노드의 손실을 더 쉽게 견디도록 구축하기에 유용하다.
- 이를 위해 큐에서 메시지를 곧바로 삭제하는 대신 잠금에서 소개한 임대 시스템을 이용하는 것을 권장한다.
- 큐 기반 시스템의 단점은 큐의 손실이 전체 시스템의 운영을 방해할 수 있다는 것이다.
- 큐를 RSM으로 구현하면 위험을 최소화하고 전체 시스템을 훨씬 더 강력하게 만들 수 있다.



